<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Conteúdo</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo base para a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Estilos para o modal */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        /* Estilos para o carrossel do calendário */
        #calendar-carousel::-webkit-scrollbar { height: 8px; }
        #calendar-carousel::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px; }
        #calendar-carousel::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        #calendar-carousel::-webkit-scrollbar-thumb:hover { background: #718096; }
        .period-btn-active, .filter-btn-active { background-color: #0891b2; color: white; }
        
        /* Styles for collapsible community panel */
        #community-panel {
            transition: max-height 0.4s ease-out, padding 0.4s ease-out, margin 0.4s ease-out, opacity 0.2s ease-out, border 0.4s ease-out;
            max-height: 200px;
            overflow: hidden;
        }
        #community-panel.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0 !important; /* Overrides space-y from parent */
            opacity: 0;
            border-width: 0;
        }
        #community-toggle-icon.rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 pb-24">

    <!-- Cabeçalho Fixo para as Views Principais -->
    <header id="main-header" class="fixed top-0 left-0 right-0 z-40 bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto p-2 space-y-1">
            <!-- Painel de Perfil -->
            <section id="profile-panel" class="bg-gray-800 p-1.5 rounded-lg flex items-center space-x-2">
                <img id="analytics-profile-pic" src="https://placehold.co/80x80/1a202c/718096?text=Perfil" class="w-8 h-8 rounded-full border-2 border-cyan-500 object-cover">
                <div class="flex-grow flex justify-around text-center">
                    <div>
                        <span id="analytics-total-posts" class="block text-xs sm:text-sm font-bold">0</span>
                        <span class="text-[10px] sm:text-xs text-gray-400">Posts</span>
                    </div>
                    <div>
                        <span id="analytics-total-followers" class="block text-xs sm:text-sm font-bold">0</span>
                        <span class="text-[10px] sm:text-xs text-gray-400">Seguidores</span>
                    </div>
                    <div>
                        <span id="analytics-total-following" class="block text-xs sm:text-sm font-bold">0</span>
                        <span class="text-[10px] sm:text-xs text-gray-400">Seguindo</span>
                    </div>
                </div>
                <!-- Botão de Toggle -->
                <button id="community-toggle-btn" class="flex-shrink-0 bg-gray-700 w-6 h-6 rounded-full flex items-center justify-center text-cyan-400 hover:bg-gray-600 transition-colors focus:outline-none">
                    <i id="community-toggle-icon" class="fas fa-chevron-up text-[10px] transition-transform duration-300"></i>
                </button>
            </section>
            <!-- Painel Community -->
            <section id="community-panel" class="bg-gray-800 p-1.5 rounded-lg flex justify-around text-center">
                <div>
                    <span id="analytics-total-members" class="block text-xs sm:text-sm font-bold">0</span>
                    <span class="text-[10px] sm:text-xs text-gray-400">Membros</span>
                </div>
                <div>
                    <span id="analytics-total-paid-members" class="block text-xs sm:text-sm font-bold">0</span>
                    <span class="text-[10px] sm:text-xs text-gray-400">Membros Pagos</span>
                </div>
                <div>
                    <span id="analytics-conversion-rate" class="block text-xs sm:text-sm font-bold">0%</span>
                    <span class="text-[10px] sm:text-xs text-gray-400">Conversão</span>
                </div>
            </section>
        </div>
    </header>

    <!-- Container da View Principal (Dashboard - Agora focado no Calendário) -->
    <div id="dashboard-view">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <main class="pt-12">
                <!-- Seção: Calendário de Conteúdo -->
                <section id="calendario">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-6">
                            <button id="prev-month" class="px-5 py-3 bg-gray-700 rounded-md hover:bg-cyan-600 transition-colors text-lg">&lt;</button>
                            <h3 id="month-year" class="text-xl sm:text-3xl font-semibold text-white"></h3>
                            <button id="next-month" class="px-5 py-3 bg-gray-700 rounded-md hover:bg-cyan-600 transition-colors text-lg">&gt;</button>
                        </div>
                        <div id="calendar-carousel" class="flex overflow-x-auto space-x-6 pb-4">
                            <!-- Day cards serão gerados aqui -->
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- Container da View de Funil -->
    <div id="funil-view" class="hidden">
         <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Lousa do Funil</h1>
                <p class="mt-2 text-base sm:text-lg text-cyan-400">Visualize e monte sua estratégia de marketing.</p>
            </header>
            <main class="flex flex-col items-center">
                <!-- Atração (Boca do Funil) -->
                <div class="w-full max-w-4xl">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4 text-center">Atração</h2>
                    <div id="funil-atracao-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 p-6 bg-gray-800/50 rounded-lg border border-gray-700">
                        <!-- Slots will be generated here -->
                    </div>
                </div>
    
                <!-- Arrow Down -->
                <div class="my-6 text-gray-600">
                    <i class="fas fa-chevron-down text-4xl"></i>
                </div>
    
                <!-- Relacionamento (Meio do Funil) -->
                <div class="w-full max-w-3xl">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-4 text-center">Relacionamento</h2>
                    <div id="funil-relacionamento-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 bg-gray-800/50 rounded-lg border border-gray-700">
                        <!-- Slots will be generated here -->
                    </div>
                </div>
    
                <!-- Arrow Down -->
                <div class="my-6 text-gray-600">
                    <i class="fas fa-chevron-down text-4xl"></i>
                </div>
    
                <!-- Conversão (Final do Funil) -->
                <div class="w-full max-w-xl">
                    <h2 class="text-2xl font-bold text-green-400 mb-4 text-center">Conversão</h2>
                    <div id="funil-venda-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 p-6 bg-gray-800/50 rounded-lg border border-gray-700">
                        <!-- Slots will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Container da View de Analytics -->
    <div id="analytics-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-tight">Analytics</h1>
                <button id="open-platform-data-modal-btn" class="px-3 py-2 bg-gray-700 rounded-md hover:bg-cyan-600 transition-colors"><i class="fas fa-cog"></i></button>
            </header>
            
            <!-- Filtros -->
            <div id="analytics-filters" class="flex justify-center space-x-2 mb-6 bg-gray-800 p-1 rounded-lg">
                <button data-range="day" class="analytics-filter-btn px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors">Hoje</button>
                <button data-range="week" class="analytics-filter-btn px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors filter-btn-active">Esta Semana</button>
                <button data-range="month" class="analytics-filter-btn px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors">Este Mês</button>
            </div>

            <!-- Gráficos -->
            <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <div class="lg:col-span-3 bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="font-semibold mb-2 text-white">Performance Geral (Engajamento %)</h3>
                    <canvas id="performance-chart"></canvas>
                </div>
                <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="font-semibold mb-2 text-white">Engajamento por Tipo de Post</h3>
                    <canvas id="engagement-type-chart"></canvas>
                </div>
            </section>

            <!-- Rankings -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="font-semibold mb-3 text-white">Top Posts por Performance</h3>
                    <div id="ranking-performance" class="space-y-2"></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="font-semibold mb-3 text-white">Top Posts por Visualizações</h3>
                    <div id="ranking-views" class="space-y-2"></div>
                </div>
            </section>
        </div>
    </div>


    <!-- Container da View do Dia (Planejamento) -->
    <div id="day-view" class="hidden min-h-screen flex-col p-4 sm:p-6 lg:p-8">
        <header class="flex items-center justify-between mb-6">
            <button id="day-view-back-btn" class="px-4 py-2 bg-gray-700 rounded-md hover:bg-cyan-600 transition-colors flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Voltar ao Calendário
            </button>
            <h2 id="day-view-date" class="text-2xl sm:text-3xl font-bold text-white text-center"></h2>
            <div class="w-32"></div> <!-- Espaçador -->
        </header>
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 flex-grow flex flex-col">
            <div id="day-view-timeline" class="space-y-4 flex-grow overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Container da View do Post (Imersiva) -->
    <div id="post-view" class="hidden min-h-screen flex-col p-4 sm:p-6 lg:p-8">
        <header class="flex items-center justify-between mb-6">
             <button id="post-view-back-btn" class="px-4 py-2 bg-gray-700 rounded-md hover:bg-cyan-600 transition-colors flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Voltar para o Dia
            </button>
            <h2 id="post-view-title" class="text-2xl sm:text-3xl font-bold text-white text-center truncate px-4"></h2>
             <div class="w-36"></div> <!-- Espaçador -->
        </header>
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
            <!-- Bloco 1: Pré-produção -->
            <div id="pre-producao-block" class="bg-gray-800 p-6 rounded-lg border border-gray-700 flex flex-col"></div>
            <!-- Bloco 2: Distribuição -->
            <div id="distribuicao-block" class="bg-gray-800 p-6 rounded-lg border border-gray-700"></div>
            <!-- Bloco 3: Analytics -->
            <div id="analytics-block" class="bg-gray-800 p-6 rounded-lg border border-gray-700"></div>
        </main>
    </div>
    
    <!-- Modal de Configuração de Período -->
    <div id="period-config-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-w-lg mx-auto p-6 relative">
            <h3 class="text-2xl font-bold text-white mb-4">Configurar Período</h3>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">1. Escolha o turno:</label>
                    <div class="flex justify-center rounded-md bg-gray-700 p-1" role="group">
                        <button id="config-period-am" class="px-5 py-2 text-sm font-medium rounded-md flex-1 transition-colors">Manhã</button>
                        <button id="config-period-pm" class="px-5 py-2 text-sm font-medium rounded-md flex-1 transition-colors">Tarde/Noite</button>
                    </div>
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">2. Escolha de 1 a 3 blocos de horário:</label>
                    <div id="config-time-blocks" class="grid grid-cols-3 gap-2"></div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancelar</button>
                    <button type="button" id="confirm-period-btn" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors opacity-50 cursor-not-allowed" disabled>Planejar Período</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ideação de Post -->
    <div id="ideation-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-w-lg mx-auto p-6 relative">
            <h3 id="ideation-modal-title" class="text-2xl font-bold text-white mb-4"></h3>
            <form id="ideation-form" class="space-y-4">
                 <input type="hidden" id="ideation-post-id">
                 <div>
                    <label for="ideation-post-type" class="block mb-2 text-sm font-medium text-gray-300">Tipo de Post</label>
                    <select id="ideation-post-type" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        <option value="stories">Stories</option>
                        <option value="cortes">Cortes (Reels, TikTok)</option>
                        <option value="curtas">Curtas</option>
                        <option value="apresentacoes">Apresentações (Carrossel)</option>
                        <option value="longas">Longas</option>
                        <option value="provas">Provas Sociais</option>
                    </select>
                 </div>
                 <div><label for="ideation-post-tema" class="block mb-2 text-sm font-medium text-gray-300">Tema</label><input type="text" id="ideation-post-tema" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                 <div><label for="ideation-post-formato" class="block mb-2 text-sm font-medium text-gray-300">Formato (Ex: Lo-fi, Tutorial, Review)</label><input type="text" id="ideation-post-formato" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                 <div><label for="ideation-post-roteiro" class="block mb-2 text-sm font-medium text-gray-300">Roteiro / Ideia Central</label><textarea id="ideation-post-roteiro" rows="4" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></textarea></div>
                 <div class="flex justify-end space-x-3 pt-2">
                     <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancelar</button>
                     <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Salvar Ideia</button>
                 </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Distribuição de Post -->
    <div id="distribution-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-w-lg mx-auto p-6 relative max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-4">Etapa 2: Distribuição</h3>
            <form id="distribution-form" class="space-y-3 overflow-y-auto pr-2 flex-grow">
                <input type="hidden" id="distribution-post-id">
                <div><label for="distribution-post-titulo" class="block text-sm font-medium text-gray-300">Título</label><input type="text" id="distribution-post-titulo" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required></div>
                <div><label for="distribution-post-descricao" class="block text-sm font-medium text-gray-300">Descrição</label><textarea id="distribution-post-descricao" rows="3" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></textarea></div>
                
                <div>
                    <label for="distribution-post-cta" class="block text-sm font-medium text-gray-300">CTA, Links & Hashtags</label>
                    <textarea id="distribution-post-cta" rows="6" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></textarea>
                </div>

                <div><label for="distribution-post-capa" class="block text-sm font-medium text-gray-300">URL da Capa</label><input type="url" id="distribution-post-capa" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Plataformas</label>
                    <div id="distribution-platforms" class="grid grid-cols-2 gap-2 text-sm"></div>
                </div>
            </form>
             <div class="flex justify-end space-x-3 pt-4 mt-2 border-t border-gray-700">
                <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancelar</button>
                <button type="submit" form="distribution-form" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Salvar Distribuição</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Inserção de Dados da Plataforma -->
    <div id="platform-data-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-w-lg mx-auto p-6 relative max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-4">Configurações de Perfil e Plataformas</h3>
            <form id="platform-data-form" class="space-y-3 overflow-y-auto pr-2 flex-grow">
                <div><label for="platform-profile-pic" class="block text-sm font-medium text-gray-300">URL da Foto de Perfil</label><input type="url" id="platform-profile-pic" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600"></div>
                <div><label for="platform-total-following" class="block text-sm font-medium text-gray-300">Total Seguindo</label><input type="number" id="platform-total-following" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600"></div>
                <hr class="border-gray-600">
                <p class="text-sm font-medium text-gray-300">Seguidores / Inscritos (Plataformas Principais)</p>
                <div id="platform-inputs" class="space-y-2"></div>
                <hr class="border-gray-600">
                <p class="text-sm font-medium text-gray-300">Membros por Ferramenta</p>
                <div id="subtool-member-inputs" class="space-y-2"></div>
                <hr class="border-gray-600">
                <p class="text-sm font-medium text-gray-300">Métricas da Comunidade (Outros)</p>
                <div><label for="platform-total-paid-members" class="block text-sm text-gray-400">Total de Membros Pagos</label><input type="number" id="platform-total-paid-members" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600"></div>
            </form>
             <div class="flex justify-end space-x-3 pt-4 mt-2 border-t border-gray-700">
                <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancelar</button>
                <button type="submit" form="platform-data-form" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700">Salvar Dados</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes da Plataforma (Funil) -->
    <div id="platform-details-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 max-w-lg mx-auto p-6 relative max-h-[90vh] flex flex-col">
            <h3 id="platform-details-title" class="text-2xl font-bold text-white mb-4"></h3>
            <form id="platform-details-form" class="space-y-4 overflow-y-auto pr-2">
                 <input type="hidden" id="platform-details-name">
                 
                 <!-- Hashtags -->
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">Hashtags</label>
                    <div id="hashtag-tags-container" class="flex flex-wrap gap-2 mb-2 p-2 bg-gray-900/50 rounded-md min-h-[40px]"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-hashtag-input" placeholder="Adicionar hashtag..." class="flex-grow bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        <button type="button" id="add-hashtag-btn" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Adicionar</button>
                    </div>
                 </div>

                 <!-- CTAs -->
                 <div><label for="platform-details-ctas" class="block mb-2 text-sm font-medium text-gray-300">CTAs (Call to Actions)</label><textarea id="platform-details-ctas" rows="3" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></textarea></div>

                 <!-- Links -->
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-300">Links</label>
                    <div id="link-tags-container" class="flex flex-wrap gap-2 mb-2 p-2 bg-gray-900/50 rounded-md min-h-[40px]"></div>
                    <div class="flex gap-2">
                        <input type="url" id="new-link-input" placeholder="https://..." class="flex-grow bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        <button type="button" id="add-link-btn" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Adicionar</button>
                    </div>
                 </div>

                 <div class="flex justify-end space-x-3 pt-4 border-t border-gray-600">
                     <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancelar</button>
                     <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Salvar</button>
                 </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Seleção de Plataforma (Funil) -->
    <div id="platform-selector-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 max-w-2xl mx-auto p-6 relative">
            <h3 class="text-2xl font-bold text-white mb-4">Selecione uma Plataforma</h3>
            <div id="platform-selector-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                <!-- Platform choices will be generated here -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Conteúdo Final do Post -->
    <div id="platform-post-content-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAllModals()"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/2 max-w-2xl mx-auto p-6 relative max-h-[90vh] flex flex-col">
            <h3 id="platform-post-content-title" class="text-2xl font-bold text-white mb-4"></h3>
            <pre id="platform-post-content-body" class="whitespace-pre-wrap break-words text-gray-300 bg-gray-900 p-4 rounded-md overflow-y-auto flex-grow"></pre>
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="copy-post-content-btn" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Copiar Conteúdo</button>
                <button type="button" onclick="closeAllModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Barra de Navegação Fixa -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around p-2 z-40">
        <button data-view="funil-view" class="nav-btn flex flex-col items-center text-gray-400 hover:text-cyan-400 transition-colors w-20">
            <i class="fas fa-sitemap text-xl"></i>
            <span class="text-xs mt-1">Funil</span>
        </button>
        <button data-view="dashboard-view" class="nav-btn flex flex-col items-center text-cyan-400 hover:text-cyan-400 transition-colors w-20"> <!-- Active by default -->
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs mt-1">Home</span>
        </button>
        <button data-view="analytics-view" class="nav-btn flex flex-col items-center text-gray-400 hover:text-cyan-400 transition-colors w-20">
            <i class="fas fa-chart-pie text-xl"></i>
            <span class="text-xs mt-1">Analytics</span>
        </button>
    </nav>


    <!-- JavaScript -->
    <script>
        // --- Lógica do App ---
        const mainHeader = document.getElementById('main-header');
        const dashboardView = document.getElementById('dashboard-view');
        const dayView = document.getElementById('day-view');
        const postView = document.getElementById('post-view');
        const funilView = document.getElementById('funil-view');
        const analyticsView = document.getElementById('analytics-view');
        const bottomNav = document.getElementById('bottom-nav');
        
        const monthYearEl = document.getElementById('month-year');
        const calendarCarouselEl = document.getElementById('calendar-carousel');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        
        const periodConfigModal = document.getElementById('period-config-modal');
        const ideationModal = document.getElementById('ideation-modal');
        const distributionModal = document.getElementById('distribution-modal');
        const platformDataModal = document.getElementById('platform-data-modal');
        const platformDetailsModal = document.getElementById('platform-details-modal');
        const platformSelectorModal = document.getElementById('platform-selector-modal');
        const platformPostContentModal = document.getElementById('platform-post-content-modal');
        
        const ideationForm = document.getElementById('ideation-form');
        const distributionForm = document.getElementById('distribution-form');
        const platformDataForm = document.getElementById('platform-data-form');
        const platformDetailsForm = document.getElementById('platform-details-form');

        let currentDate = new Date();
        
        let postsData;
        try {
            postsData = JSON.parse(localStorage.getItem('calendarPosts')) || {};
            if (typeof postsData !== 'object' || postsData === null) postsData = {};
        } catch (e) {
            console.error("Could not parse calendarPosts from localStorage, starting fresh.", e);
            postsData = {};
        }

        let platformData = JSON.parse(localStorage.getItem('platformData')) || {};
        let funilData = JSON.parse(localStorage.getItem('funilData')) || {};
        let funilLayoutData = JSON.parse(localStorage.getItem('funilLayoutData')) || {
            atracao: [],
            relacionamento: [],
            venda: []
        };
        
        let isCommunityPanelCollapsed = JSON.parse(localStorage.getItem('isCommunityPanelCollapsed')) || false;
        const communityToggleBtn = document.getElementById('community-toggle-btn');
        const communityToggleIcon = document.getElementById('community-toggle-icon');
        const communityPanel = document.getElementById('community-panel');

        let currentDayViewDate = null;
        let currentPostId = null;
        let configSelectedPeriod = 'am';
        let configSelectedBlocks = [];
        let activeDayViewPeriod = 'am';
        let activeDayViewBlocks = [];
        let performanceChartInstance = null;
        let engagementTypeChartInstance = null;

        const POST_VISUALS = {
            stories: { label: 'Stories', icon: 'fa-square', color: 'bg-green-500', textColor: 'text-green-400', chartColor: 'rgba(74, 222, 128, 0.7)' },
            cortes: { label: 'Cortes', icon: 'fa-rectangle-vertical', color: 'bg-pink-500', textColor: 'text-pink-400', chartColor: 'rgba(236, 72, 153, 0.7)' },
            curtas: { label: 'Curtas', icon: 'custom-curtas', color: 'bg-pink-500', textColor: 'text-pink-400', chartColor: 'rgba(168, 85, 247, 0.7)' },
            apresentacoes: { label: 'Apresentações', icon: 'fa-clone', color: 'bg-yellow-500', textColor: 'text-yellow-400', chartColor: 'rgba(234, 179, 8, 0.7)' },
            longas: { label: 'Longas', icon: 'fa-rectangle-horizontal', color: 'bg-red-500', textColor: 'text-red-400', chartColor: 'rgba(239, 68, 68, 0.7)' },
            provas: { label: 'Provas', icon: 'fa-circle', color: 'bg-cyan-500', textColor: 'text-cyan-400', chartColor: 'rgba(34, 211, 238, 0.7)' }
        };

        const PLATFORM_DETAILS = {
            'Instagram': { icon: 'fa-brands fa-instagram', color: 'text-pink-500', isMain: true },
            'Canais do Insta': { icon: 'fas fa-bullhorn', color: 'text-pink-300', isMain: false },
            'DM do Insta': { icon: 'fas fa-paper-plane', color: 'text-pink-400', isMain: false },
            'Facebook': { icon: 'fa-brands fa-facebook', color: 'text-blue-600', isMain: true },
            'Messenger': { icon: 'fa-brands fa-facebook-messenger', color: 'text-blue-500', isMain: false },
            'Páginas do Face': { icon: 'fas fa-file-alt', color: 'text-blue-400', isMain: false },
            'Grupos do Face': { icon: 'fas fa-users', color: 'text-blue-400', isMain: false },
            'TikTok': { icon: 'fa-brands fa-tiktok', color: 'text-white', isMain: true },
            'DM do TikTok': { icon: 'fas fa-paper-plane', color: 'text-gray-300', isMain: false },
            'YouTube': { icon: 'fa-brands fa-youtube', color: 'text-red-600', isMain: true },
            'Twitch': { icon: 'fa-brands fa-twitch', color: 'text-purple-600', isMain: true },
            'LinkedIn': { icon: 'fa-brands fa-linkedin', color: 'text-blue-700', isMain: true },
            'WhatsApp': { icon: 'fa-brands fa-whatsapp', color: 'text-green-500', isMain: true },
            'Comunidades do Wpp': { icon: 'fas fa-users', color: 'text-green-400', isMain: false },
            'Grupos de Wpp': { icon: 'fas fa-user-friends', color: 'text-green-300', isMain: false },
            'Telegram': { icon: 'fa-brands fa-telegram', color: 'text-sky-500', isMain: true },
            'Grupos de Tele': { icon: 'fas fa-user-friends', color: 'text-sky-400', isMain: false },
            'Discord': { icon: 'fa-brands fa-discord', color: 'text-indigo-500', isMain: true },
            'Servidores do Discord': { icon: 'fas fa-server', color: 'text-indigo-400', isMain: false },
            'Site/Blog': { icon: 'fas fa-globe', color: 'text-gray-400', isMain: true }
        };
        const ALL_PLATFORMS = Object.keys(PLATFORM_DETAILS);
        const MAIN_PLATFORMS = ALL_PLATFORMS.filter(p => PLATFORM_DETAILS[p].isMain);
        const SUB_TOOLS = ALL_PLATFORMS.filter(p => !PLATFORM_DETAILS[p].isMain);

        function savePosts() { localStorage.setItem('calendarPosts', JSON.stringify(postsData)); }
        function savePlatformData() { localStorage.setItem('platformData', JSON.stringify(platformData)); }
        function saveFunilData() { localStorage.setItem('funilData', JSON.stringify(funilData)); }
        function saveFunilLayoutData() { localStorage.setItem('funilLayoutData', JSON.stringify(funilLayoutData)); }


        function updateBodyPadding() {
            const header = document.getElementById('main-header');
            if (header && window.getComputedStyle(header).display !== 'none') {
                const headerHeight = header.offsetHeight;
                document.body.style.paddingTop = `${headerHeight}px`;
            } else {
                document.body.style.paddingTop = '0px';
            }
        }

        function applyCommunityPanelState() {
            communityPanel.classList.toggle('collapsed', isCommunityPanelCollapsed);
            communityToggleIcon.classList.toggle('rotate-180', isCommunityPanelCollapsed);
        }

        function toggleCommunityPanel() {
            isCommunityPanelCollapsed = !isCommunityPanelCollapsed;
            localStorage.setItem('isCommunityPanelCollapsed', JSON.stringify(isCommunityPanelCollapsed));
            applyCommunityPanelState();
            setTimeout(updateBodyPadding, 400); // Wait for animation
        }

        // --- Renderização de Views ---
        function renderCalendar() {
            calendarCarouselEl.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            monthYearEl.textContent = `${monthNames[month]} de ${year}`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const dayPostCounts = Object.keys(postsData)
                    .filter(key => key.startsWith(dateStr))
                    .reduce((acc, key) => {
                        try {
                            const post = postsData[key];
                            if (post && post.type) acc[post.type] = (acc[post.type] || 0) + 1;
                        } catch(e) { console.error('Error processing post data:', postsData[key]) }
                        return acc;
                    }, {});

                let iconsHtml = '<div class="grid grid-cols-2 gap-x-2 gap-y-2 mt-2 w-full px-1">';
                const postTypeOrder = ['stories', 'cortes', 'curtas', 'apresentacoes', 'longas', 'provas'];

                postTypeOrder.forEach(type => {
                    const count = dayPostCounts[type] || 0;
                    const hasPosts = count > 0;
                    const visual = POST_VISUALS[type];
                    let iconContent = '';
                    
                    const iconContainer = `<div class="w-8 h-8 flex items-center justify-center">`;

                    switch (type) {
                        case 'cortes':
                            iconContent = `${iconContainer}<div class="w-4 h-6 ${hasPosts ? 'bg-pink-500' : 'bg-gray-600'} rounded-sm"></div></div>`;
                            break;
                        case 'longas':
                            iconContent = `${iconContainer}<div class="w-6 h-4 ${hasPosts ? 'bg-red-500' : 'bg-gray-600'} rounded-sm"></div></div>`;
                            break;
                        case 'curtas':
                            const pinkColor = hasPosts ? 'bg-pink-500' : 'bg-gray-600';
                            const redColor = hasPosts ? 'bg-red-500' : 'bg-gray-500';
                            iconContent = `${iconContainer}<div class="relative w-full h-full"><div class="absolute top-1 left-2 w-4 h-6 ${pinkColor} rounded-sm"></div><div class="absolute bottom-1 w-5 h-2.5 ${redColor} rounded-sm"></div></div></div>`;
                            break;
                        default: // stories, apresentacoes, provas
                            iconContent = `${iconContainer}<i class="fas ${visual.icon} fa-fw ${hasPosts ? visual.textColor : 'text-gray-500'} text-2xl"></i></div>`;
                            break;
                    }
                    
                    iconsHtml += `<div class="flex items-center">${iconContent}<span class="ml-1.5 font-bold text-base ${hasPosts ? 'text-gray-100' : 'text-gray-500'}">${count}</span></div>`;
                });
                iconsHtml += '</div>';

                const dayEl = document.createElement('div');
                dayEl.className = 'flex-shrink-0 w-32 h-56 flex flex-col justify-start items-center p-3 rounded-lg bg-gray-700 cursor-pointer transition-all duration-300 hover:bg-cyan-700 hover:shadow-lg';
                dayEl.innerHTML = `<div class="text-center mb-2"><span class="font-semibold text-gray-400 text-sm">${dayNames[date.getDay()]}</span><span class="block text-4xl font-bold text-white">${day}</span></div><div class="flex-grow w-full flex items-center">${iconsHtml}</div>`;
                dayEl.dataset.date = dateStr;
                dayEl.onclick = () => openPeriodConfigModal(dateStr);
                
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('border-2', 'border-cyan-500', 'bg-gray-600');
                    dayEl.classList.remove('bg-gray-700');
                }
                calendarCarouselEl.appendChild(dayEl);
            }
        }
        
        function renderFunilPage() {
            const stages = ['atracao', 'relacionamento', 'venda'];

            stages.forEach(stage => {
                const container = document.getElementById(`funil-${stage}-container`);
                if (!container) return;
                container.innerHTML = '';

                funilLayoutData[stage].forEach((platformName, index) => {
                    if (platformName) {
                        const details = PLATFORM_DETAILS[platformName];
                        
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col items-center justify-center space-y-3 min-h-[7rem] relative group';
                        
                        card.innerHTML = `
                            <button onclick="removePlatformFromSlot(event, '${stage}', ${index})" class="absolute top-1 right-1 w-6 h-6 bg-red-600/50 hover:bg-red-600 rounded-full text-white text-xs z-10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                            <div class="w-full h-full flex flex-col items-center justify-center cursor-pointer" onclick="openPlatformDetailsModal('${platformName}')">
                                <i class="${details.icon} ${details.color} text-4xl"></i>
                                <span class="text-white font-semibold text-sm text-center mt-2">${platformName}</span>
                            </div>
                        `;
                        container.appendChild(card);
                    } else {
                        const emptySlot = document.createElement('div');
                        emptySlot.className = 'bg-gray-800/30 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center min-h-[7rem] cursor-pointer hover:bg-gray-700 transition-colors';
                        emptySlot.onclick = () => openPlatformSelectorModal(stage, index);
                        emptySlot.innerHTML = `<i class="fas fa-plus text-gray-500 text-3xl"></i>`;
                        container.appendChild(emptySlot);
                    }
                });

                // Botão de adicionar novo slot
                const addButton = document.createElement('div');
                addButton.className = 'bg-gray-800/30 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center min-h-[7rem] cursor-pointer hover:bg-gray-700 transition-colors';
                addButton.onclick = () => addFunilSlot(stage);
                addButton.innerHTML = `<i class="fas fa-plus text-gray-500 text-3xl"></i>`;
                container.appendChild(addButton);
            });
        }

        // --- Navegação e Views ---
        function updateNavButtons(activeViewId) {
            document.querySelectorAll('#bottom-nav button').forEach(btn => {
                btn.classList.toggle('text-cyan-400', btn.dataset.view === activeViewId);
                btn.classList.toggle('text-gray-400', btn.dataset.view !== activeViewId);
            });
        }

        function navigateTo(viewId) {
            mainHeader.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            funilView.classList.add('hidden');
            analyticsView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            updateNavButtons(viewId);
            
            if (viewId === 'analytics-view') {
                renderAnalyticsPage();
            } else if (viewId === 'funil-view') {
                renderFunilPage();
            }

            updateBodyPadding();
        }

        function showDashboardView() {
            navigateTo('dashboard-view');
            bottomNav.classList.remove('hidden');
            dayView.classList.add('hidden');
            postView.classList.add('hidden');
            renderCalendar();
        }

        function showDayView(dateStr, period, blocks) {
            currentDayViewDate = dateStr; activeDayViewPeriod = period; activeDayViewBlocks = blocks;
            mainHeader.classList.add('hidden');
            dashboardView.classList.add('hidden'); funilView.classList.add('hidden'); analyticsView.classList.add('hidden');
            dayView.classList.remove('hidden'); dayView.classList.add('flex');
            postView.classList.add('hidden'); bottomNav.classList.add('hidden');
            document.getElementById('day-view-date').textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            renderDayTimeline(period, blocks);
            updateBodyPadding();
        }

        function showPostView(postId) {
            currentPostId = postId; const post = postsData[postId]; if (!post) return;
            mainHeader.classList.add('hidden');
            dashboardView.classList.add('hidden'); dayView.classList.add('hidden'); funilView.classList.add('hidden'); analyticsView.classList.add('hidden');
            postView.classList.remove('hidden'); postView.classList.add('flex'); bottomNav.classList.add('hidden');
            document.getElementById('post-view-title').textContent = post.titulo || post.tema || 'Novo Post';
            renderPreProducaoBlock(post); renderDistribuicaoBlock(post); renderAnalyticsBlock(post);
            updateBodyPadding();
        }

        // --- Lógica de Modais ---
        function openPeriodConfigModal(dateStr) {
            currentDayViewDate = dateStr; configSelectedPeriod = 'am'; configSelectedBlocks = [];
            renderPeriodConfigModalContent(); periodConfigModal.style.display = 'flex';
        }
        
        function openIdeationModal(dateStr, hour, minute) {
            const hourStr = String(hour).padStart(2, '0'), minuteStr = String(minute).padStart(2, '0');
            const postId = `${dateStr}-${hourStr}-${minuteStr}`;
            document.getElementById('ideation-modal-title').textContent = `Ideia de Post para ${new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR')} às ${hourStr}:${minuteStr}`;
            document.getElementById('ideation-post-id').value = postId; ideationForm.reset(); ideationModal.style.display = 'flex';
        }

        function openDistributionModal(postId) {
            const post = postsData[postId]; if (!post) return;
            document.getElementById('distribution-post-id').value = postId; distributionForm.reset();
            document.getElementById('distribution-post-titulo').value = post.titulo || '';
            document.getElementById('distribution-post-descricao').value = post.descricao || '';
            document.getElementById('distribution-post-cta').value = post.cta || '';
            document.getElementById('distribution-post-capa').value = post.capa || '';
            
            const platformsContainer = document.getElementById('distribution-platforms');
            platformsContainer.innerHTML = '';
            ALL_PLATFORMS.forEach(platform => {
                const isChecked = post.plataformas?.includes(platform);
                platformsContainer.innerHTML += `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" value="${platform}" ${isChecked ? 'checked' : ''} class="form-checkbox platform-checkbox bg-gray-600 border-gray-500 rounded text-cyan-500 focus:ring-cyan-600"><span>${platform}</span></label>`;
            });

            platformsContainer.addEventListener('change', updateCombinedCtaField);
            if (!post.cta) { // Only auto-fill if the cta field is empty
                updateCombinedCtaField();
            }

            distributionModal.style.display = 'flex';
        }

        function openPlatformDataModal() {
            document.getElementById('platform-profile-pic').value = platformData.profilePic || '';
            document.getElementById('platform-total-following').value = platformData.totalFollowing || '';
            document.getElementById('platform-total-paid-members').value = platformData.totalPaidMembers || '';
            
            const inputsContainer = document.getElementById('platform-inputs');
            inputsContainer.innerHTML = '';
            MAIN_PLATFORMS.forEach(p => {
                inputsContainer.innerHTML += `<div class="flex items-center"><label for="platform-${p}" class="w-2/5 text-sm">${p}</label><input type="number" id="platform-${p}" value="${platformData[p] || ''}" class="w-3/5 bg-gray-700 text-white p-1.5 rounded-md border border-gray-600 text-sm"></div>`;
            });

            const subtoolsContainer = document.getElementById('subtool-member-inputs');
            subtoolsContainer.innerHTML = '';
            SUB_TOOLS.forEach(p => {
                subtoolsContainer.innerHTML += `<div class="flex items-center"><label for="subtool-${p}" class="w-2/5 text-sm">${p}</label><input type="number" id="subtool-${p}" value="${platformData.members?.[p] || ''}" class="w-3/5 bg-gray-700 text-white p-1.5 rounded-md border border-gray-600 text-sm"></div>`;
            });


            platformDataModal.style.display = 'flex';
        }
        
        function openPlatformDetailsModal(platformName) {
            document.getElementById('platform-details-title').textContent = `Estratégia para ${platformName}`;
            document.getElementById('platform-details-name').value = platformName;
            
            const data = funilData[platformName] || {};

            renderTagInput('hashtag', data.hashtags || []);
            renderTagInput('link', data.links || []);
            
            document.getElementById('platform-details-ctas').value = data.ctas || '';

            platformDetailsModal.style.display = 'flex';
        }

        function openPlatformSelectorModal(stage, index) {
            const grid = document.getElementById('platform-selector-grid');
            grid.innerHTML = '';

            ALL_PLATFORMS.forEach(platformName => {
                const details = PLATFORM_DETAILS[platformName];
                const card = document.createElement('button');
                card.className = `bg-gray-700 p-4 rounded-lg flex flex-col items-center justify-center space-y-2 transition-colors hover:bg-cyan-700`;
                card.onclick = () => selectPlatformForSlot(stage, index, platformName);

                card.innerHTML = `
                    <i class="${details.icon} ${details.color} text-3xl"></i>
                    <span class="text-white font-semibold text-xs text-center">${platformName}</span>
                `;
                grid.appendChild(card);
            });

            platformSelectorModal.style.display = 'flex';
        }
        
        function showPlatformPostContentModal(postId, platformName) {
            const post = postsData[postId];
            if (!post) return;

            document.getElementById('platform-post-content-title').textContent = `Conteúdo Final para: ${platformName}`;
            
            const body = document.getElementById('platform-post-content-body');
            const platformFunilData = funilData[platformName] || {};

            let finalContent = `${post.titulo || ''}\n`;
            finalContent += `-----------------------------------------\n`;
            finalContent += `${post.descricao || ''}\n`;
            finalContent += `---------------------------------------------\n\n`;
            
            if (platformFunilData.ctas && platformFunilData.ctas.trim() !== '') {
                finalContent += `${platformFunilData.ctas}\n\n`;
                finalContent += `----------------------------------------------\n\n`;
            }
            
            if (platformFunilData.links && platformFunilData.links.length > 0) {
                finalContent += `${platformFunilData.links.join('\n')}\n\n`;
                finalContent += `---------------------------------------------------\n\n`;
            }

            if (platformFunilData.hashtags && platformFunilData.hashtags.length > 0) {
                finalContent += `${platformFunilData.hashtags.join(' ')}`;
            }
            
            body.textContent = finalContent.trim();
            platformPostContentModal.style.display = 'flex';
        }

        function selectPlatformForSlot(stage, index, platformName) {
            funilLayoutData[stage][index] = platformName;
            saveFunilLayoutData();
            renderFunilPage();
            closeAllModals();
        }

        function removePlatformFromSlot(event, stage, index) {
            event.stopPropagation();
            funilLayoutData[stage].splice(index, 1);
            saveFunilLayoutData();
            renderFunilPage();
        }

        function addFunilSlot(stage) {
            if (funilLayoutData[stage]) {
                funilLayoutData[stage].push(null);
                saveFunilLayoutData();
                renderFunilPage();
            }
        }

        function closeAllModals() {
            periodConfigModal.style.display = 'none'; ideationModal.style.display = 'none';
            distributionModal.style.display = 'none'; platformDataModal.style.display = 'none';
            platformDetailsModal.style.display = 'none';
            platformSelectorModal.style.display = 'none';
            platformPostContentModal.style.display = 'none';
        }
        
        // --- Lógica de Tags (Hashtags/Links) ---
        function renderTagInput(type, items) {
            const container = document.getElementById(`${type}-tags-container`);
            container.innerHTML = '';
            (items || []).forEach(item => {
                const tag = createTagElement(item);
                container.appendChild(tag);
            });
        }

        function createTagElement(text) {
            const tag = document.createElement('div');
            tag.className = 'bg-gray-700 text-sm rounded-full px-3 py-1 flex items-center gap-2';
            tag.innerHTML = `
                <span>${text}</span>
                <button type="button" class="text-gray-400 hover:text-white">&times;</button>
            `;
            tag.querySelector('button').onclick = () => tag.remove();
            return tag;
        }

        function addTag(type) {
            const input = document.getElementById(`new-${type}-input`);
            const container = document.getElementById(`${type}-tags-container`);
            const value = input.value.trim();
            if (value) {
                const tag = createTagElement(value);
                container.appendChild(tag);
                input.value = '';
            }
        }

        // --- Sugestões no Modal de Distribuição ---
        function updateCombinedCtaField() {
            const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked')).map(el => el.value);
            const ctaTextarea = document.getElementById('distribution-post-cta');

            // If no platform is selected, clear the textarea
            if (selectedPlatforms.length === 0) {
                ctaTextarea.value = '';
                return;
            }

            // Use only the first selected platform for pre-filling
            const firstPlatformName = selectedPlatforms[0];
            const data = funilData[firstPlatformName] || {};
            
            let finalText = '';
            if (data.ctas) {
                finalText += data.ctas;
            }
            if (data.links && data.links.length > 0) {
                finalText += (finalText ? '\n\n---\n\n' : '') + data.links.join('\n');
            }
            if (data.hashtags && data.hashtags.length > 0) {
                finalText += (finalText ? '\n\n' : '') + data.hashtags.join(' ');
            }
            
            ctaTextarea.value = finalText;
        }

        // --- Renderização de Blocos e Conteúdo ---
        function renderDayTimeline(period, blocks) {
            const timelineEl = document.getElementById('day-view-timeline'); timelineEl.innerHTML = '';
            blocks.sort((a, b) => a - b);
            const blockLabels = { am: ["00:00 - 03:59", "04:00 - 07:59", "08:00 - 11:59"], pm: ["12:00 - 15:59", "16:00 - 19:59", "20:00 - 23:59"] };
            blocks.forEach(block => {
                const header = document.createElement('h4');
                header.className = 'text-lg font-semibold text-cyan-400 pt-4 pb-2 border-t border-gray-700 first:border-t-0 first:pt-0';
                header.textContent = `Bloco: ${blockLabels[period][block]}`;
                timelineEl.appendChild(header);
                const startHour = period === 'am' ? block * 4 : 12 + block * 4;
                for (let i = 0; i < 4; i++) {
                    const hour = startHour + i; const hourStr = String(hour).padStart(2, '0');
                    const hourRowEl = document.createElement('div'); hourRowEl.className = 'flex items-start';
                    hourRowEl.innerHTML = `<div class="font-bold w-12 text-gray-400 pt-2 text-sm">${hourStr}:00</div>`;
                    const slotsContainerEl = document.createElement('div');
                    slotsContainerEl.className = 'flex-grow grid grid-cols-3 sm:grid-cols-6 gap-1 ml-4';
                    for (let j = 0; j < 6; j++) {
                        const minute = j * 10; const minuteStr = String(minute).padStart(2, '0');
                        const postId = `${currentDayViewDate}-${hourStr}-${minuteStr}`;
                        const post = postsData[postId];
                        const slotEl = document.createElement('div');
                        slotEl.className = 'h-10 rounded-md flex items-center justify-center cursor-pointer transition-colors';
                        slotEl.onclick = () => { post ? showPostView(postId) : openIdeationModal(currentDayViewDate, hour, minute); };
                        if (post) { slotEl.innerHTML = createPostVisual(post); slotEl.title = post.titulo || post.tema; } 
                        else { slotEl.className += ' bg-gray-700 hover:bg-gray-600'; slotEl.innerHTML = `<i class="fa-solid fa-plus text-gray-500"></i>`; }
                        slotsContainerEl.appendChild(slotEl);
                    }
                    hourRowEl.appendChild(slotsContainerEl); timelineEl.appendChild(hourRowEl);
                }
            });
        }
        
        function createPostVisual(post) {
            const v = POST_VISUALS[post.type];
            if (!v) return '<div>?</div>'; // Fallback for unknown type
            
            const title = post.titulo || post.tema || '';

            switch (post.type) {
                case 'cortes':
                    return `<div class="flex items-center justify-center h-full w-full" title="${title}"><div class="w-3 h-5 ${v.color} rounded-sm"></div></div>`;
                case 'longas':
                    return `<div class="flex items-center justify-center h-full w-full" title="${title}"><div class="w-5 h-3 ${v.color} rounded-sm"></div></div>`;
                case 'curtas':
                    return `<div class="relative w-5 h-6 flex items-center justify-center" title="${title}"><div class="absolute w-3 h-5 ${v.color} rounded-sm"></div><div class="absolute bottom-0 w-4 h-2 bg-red-500 rounded-sm"></div></div>`;
                case 'apresentacoes':
                    return `<div class="relative w-6 h-6" title="${title}"><div class="absolute top-1 left-1 w-5 h-5 ${v.color} rounded-sm opacity-70"></div><div class="absolute top-0 left-0 w-5 h-5 ${v.color} rounded-sm flex items-center justify-center text-white"><i class="fas ${v.icon} text-xs"></i></div></div>`;
                default: // stories, provas
                    return `<div class="flex items-center justify-center text-white w-6 h-6 ${v.color} rounded-sm"><i class="fas ${v.icon} text-base"></i></div>`;
            }
        }
        
        function renderPreProducaoBlock(post) {
            const block = document.getElementById('pre-producao-block'), v = POST_VISUALS[post.type];
            block.innerHTML = `<h3 class="text-2xl font-bold text-white mb-4">1. Pré-produção</h3><div class="flex-grow space-y-4 text-gray-300"><p><strong>Tipo:</strong> <span class="px-2 py-1 ${v.color} text-white text-xs rounded-full">${POST_VISUALS[post.type]?.label || post.type}</span></p><p class="break-words"><strong>Tema:</strong> ${post.tema || 'Não definido'}</p><p class="break-words"><strong>Formato:</strong> ${post.formato || 'Não definido'}</p><div><strong>Roteiro/Ideia:</strong><div class="mt-1 p-2 bg-gray-900 rounded-md text-sm whitespace-pre-wrap break-words">${post.roteiro || 'Não definido'}</div></div></div><div class="flex space-x-2 mt-6"><button onclick="handleDeletePost('${currentPostId}')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 w-1/2">Deletar</button><button onclick="openDistributionModal('${currentPostId}')" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 w-1/2">Distribuir</button></div>`;
        }

        function renderDistribuicaoBlock(post) {
            const block = document.getElementById('distribuicao-block');
            let content;
            if (post.status === 'distribuido') {
                const platformButtons = (post.plataformas || [])
                    .map(p => `<button onclick="showPlatformPostContentModal('${currentPostId}', '${p}')" class="bg-gray-700 text-sm hover:bg-cyan-600 px-3 py-1 rounded-full">${p}</button>`)
                    .join('');

                content = `
                    <div class="space-y-4 text-gray-300 text-sm break-words">
                        <p><strong>Título:</strong> ${post.titulo}</p>
                        <div><strong>Descrição:</strong><div class="mt-1 p-2 bg-gray-900 rounded-md whitespace-pre-wrap">${post.descricao || 'N/A'}</div></div>
                        <p><strong>Plataformas:</p>
                        <div class="flex flex-wrap gap-2">${platformButtons}</div>
                    </div>
                `;
            } else {
                content = `<div class="text-center text-gray-500 flex flex-col items-center justify-center h-full"><i class="fas fa-paper-plane fa-3x mb-4"></i><p>Aguardando distribuição.</p><p class="text-xs">Clique "Distribuir" na pré-produção.</p></div>`;
            }
            block.innerHTML = `<h3 class="text-2xl font-bold text-white mb-4">2. Distribuição</h3>${content}`;
        }

        function renderAnalyticsBlock(post) {
            const block = document.getElementById('analytics-block');
            let content;
            if (post.status !== 'distribuido') {
                content = `<div class="text-center text-gray-500 flex flex-col items-center justify-center h-full"><i class="fas fa-chart-line fa-3x mb-4"></i><p>Disponível após a distribuição.</p></div>`;
                block.innerHTML = `<h3 class="text-2xl font-bold text-white mb-4">3. Analytics</h3>${content}`;
                return;
            }
            
            const analytics = post.analytics || {};
            const calculators = {
                stories: { label: 'Taxa de Engajamento', p1: 'Visualizações', p2: 'Respostas + Interações' },
                cortes: { label: 'Taxa de Compartilhamento', p1: 'Visualizações', p2: 'Compartilhamentos' },
                curtas: { label: 'Taxa de Retenção', p1: 'Retenção (%)' },
                apresentacoes: { label: 'Taxa de Autoridade', p1: 'Visualizações', p2: 'Salvamentos' },
                longas: { label: 'Taxa de Retenção', p1: 'Retenção (%)' },
                provas: { label: 'Taxa de Relevância', p1: 'Visualizações', p2: 'Curtidas + Comentários' }
            };
            const calc = calculators[post.type] || { label: 'Engajamento', p1: 'Visualizações', p2: 'Métrica' };
            
            let engagement = 0;
            if (post.type === 'longas' || post.type === 'curtas') {
                engagement = analytics.input1 || 0;
            } else {
                const views = analytics.input1 || 0;
                const metric = analytics.input2 || 0;
                engagement = views > 0 ? (metric / views) * 100 : 0;
            }
            const performance = analytics.performance || '';

            let performanceColor = 'text-white';
            if (performance === 'Viral') performanceColor = 'text-cyan-400 font-extrabold';
            else if (performance === 'Bom') performanceColor = 'text-green-400';
            else if (performance === 'Médio') performanceColor = 'text-yellow-400';
            else if (performance === 'Ruim') performanceColor = 'text-red-400';

            let inputsHtml = '';
            if (post.type === 'longas' || post.type === 'curtas') {
                inputsHtml = `<input type="number" id="post-analytics-input1" placeholder="${calc.p1}" value="${analytics.input1 || ''}" class="w-full bg-gray-700 p-2 rounded-md border border-gray-600">`;
            } else {
                inputsHtml = `
                    <input type="number" id="post-analytics-input1" placeholder="${calc.p1}" value="${analytics.input1 || ''}" class="w-full bg-gray-700 p-2 rounded-md border border-gray-600">
                    <input type="number" id="post-analytics-input2" placeholder="${calc.p2}" value="${analytics.input2 || ''}" class="w-full bg-gray-700 p-2 rounded-md border border-gray-600">
                `;
            }

            content = `
                <div class="space-y-3">
                    ${inputsHtml}
                    <button onclick="calculatePostAnalytics('${currentPostId}')" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md">Calcular & Salvar</button>
                    <p class="text-center text-lg mt-2">${calc.label}: <span id="post-analytics-result" class="font-bold text-white">${engagement.toFixed(2)}%</span></p>
                    <p class="text-center text-lg">Performance: <span id="post-performance-feedback" class="font-bold ${performanceColor}">${performance}</span></p>
                </div>
            `;
            block.innerHTML = `<h3 class="text-2xl font-bold text-white mb-4">3. Analytics</h3>${content}`;
        }
        
        function calculatePostAnalytics(postId) {
            const post = postsData[postId];
            if (!post) return;
            
            let engagement = 0;
            let feedback = '';
            
            const input1 = parseFloat(document.getElementById('post-analytics-input1')?.value) || 0;
            
            if (post.type === 'longas' || post.type === 'curtas') {
                engagement = input1;
                post.analytics = { input1 };
            } else {
                const input2 = parseFloat(document.getElementById('post-analytics-input2')?.value) || 0;
                engagement = input1 > 0 ? (input2 / input1) * 100 : 0;
                post.analytics = { input1, input2 };
            }

            switch (post.type) {
                case 'stories':
                    if (engagement > 30) feedback = 'Viral';
                    else if (engagement > 10) feedback = 'Bom';
                    else if (engagement >= 5) feedback = 'Médio';
                    else feedback = 'Ruim';
                    break;
                case 'cortes': // REELS
                    if (engagement > 3) feedback = 'Viral';
                    else if (engagement > 1) feedback = 'Bom';
                    else if (engagement >= 0.3) feedback = 'Médio';
                    else feedback = 'Ruim';
                    break;
                case 'apresentacoes': // CARROSSEL
                case 'provas': // FOTOS DO FEED
                    if (engagement > 24) feedback = 'Viral';
                    else if (engagement > 8) feedback = 'Bom';
                    else if (engagement >= 3) feedback = 'Médio';
                    else feedback = 'Ruim';
                    break;
                case 'curtas':
                    if (engagement > 100) feedback = 'Viral';
                    else if (engagement > 60) feedback = 'Bom';
                    else if (engagement >= 40) feedback = 'Médio';
                    else feedback = 'Ruim';
                    break;
                case 'longas':
                    if (engagement > 100) feedback = 'Viral';
                    else if (engagement > 50) feedback = 'Bom';
                    else if (engagement >= 30) feedback = 'Médio';
                    else feedback = 'Ruim';
                    break;
                default:
                    feedback = 'N/A';
            }

            post.analytics.performance = feedback;
            savePosts();

            // Update UI
            document.getElementById('post-analytics-result').textContent = `${engagement.toFixed(2)}%`;
            const feedbackEl = document.getElementById('post-performance-feedback');
            feedbackEl.textContent = feedback;
            
            feedbackEl.classList.remove('text-cyan-400', 'font-extrabold', 'text-green-400', 'text-yellow-400', 'text-red-400', 'text-white');
            if (feedback === 'Viral') feedbackEl.classList.add('text-cyan-400', 'font-extrabold');
            else if (feedback === 'Bom') feedbackEl.classList.add('text-green-400');
            else if (feedback === 'Médio') feedbackEl.classList.add('text-yellow-400');
            else if (feedback === 'Ruim') feedbackEl.classList.add('text-red-400');
        }

        // --- Handlers de Ações e Formulários ---
        function handleDeletePost(postId) {
            if (confirm('Tem certeza que deseja deletar este post?')) {
                delete postsData[postId]; savePosts();
                showDayView(currentDayViewDate, activeDayViewPeriod, activeDayViewBlocks);
            }
        }

        ideationForm.addEventListener('submit', (e) => {
            e.preventDefault(); const postId = document.getElementById('ideation-post-id').value;
            postsData[postId] = { type: document.getElementById('ideation-post-type').value, tema: document.getElementById('ideation-post-tema').value, formato: document.getElementById('ideation-post-formato').value, roteiro: document.getElementById('ideation-post-roteiro').value, status: 'ideia' };
            savePosts(); closeAllModals(); renderDayTimeline(activeDayViewPeriod, activeDayViewBlocks);
        });

        distributionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const postId = document.getElementById('distribution-post-id').value;
            const post = postsData[postId];
            if (!post) return;
            
            const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked')).map(el => el.value);

            post.titulo = document.getElementById('distribution-post-titulo').value;
            post.descricao = document.getElementById('distribution-post-descricao').value;
            post.cta = document.getElementById('distribution-post-cta').value;
            post.capa = document.getElementById('distribution-post-capa').value;
            post.plataformas = selectedPlatforms;
            post.status = 'distribuido';

            savePosts();
            closeAllModals();
            showPostView(postId);
        });

        platformDataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            platformData.profilePic = document.getElementById('platform-profile-pic').value;
            platformData.totalFollowing = parseInt(document.getElementById('platform-total-following').value) || 0;
            platformData.totalPaidMembers = parseInt(document.getElementById('platform-total-paid-members').value) || 0;
            
            MAIN_PLATFORMS.forEach(p => {
                const val = parseInt(document.getElementById(`platform-${p}`).value) || 0;
                if (val > 0) platformData[p] = val; else delete platformData[p];
            });

            platformData.members = {};
            SUB_TOOLS.forEach(p => {
                const val = parseInt(document.getElementById(`subtool-${p}`).value) || 0;
                if (val > 0) platformData.members[p] = val;
            });

            savePlatformData();
            closeAllModals();
            renderFixedHeader();
            if (document.getElementById('analytics-view').classList.contains('hidden') === false) {
                renderAnalyticsPage();
            }
        });
        
        platformDetailsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const platformName = document.getElementById('platform-details-name').value;
            if (!funilData[platformName]) {
                funilData[platformName] = {};
            }

            const hashtags = Array.from(document.querySelectorAll('#hashtag-tags-container span')).map(span => span.textContent);
            const links = Array.from(document.querySelectorAll('#link-tags-container span')).map(span => span.textContent);

            funilData[platformName].hashtags = hashtags;
            funilData[platformName].links = links;
            funilData[platformName].ctas = document.getElementById('platform-details-ctas').value;
            
            saveFunilData();
            closeAllModals();
        });

        // --- Lógica de Analytics Page ---
        function getFilteredPosts(range) {
            const now = new Date();
            let startDate = new Date();
            if (range === 'day') startDate.setHours(0, 0, 0, 0);
            if (range === 'week') {
                startDate.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1)); // start on monday
                startDate.setHours(0, 0, 0, 0);
            }
            if (range === 'month') {
                startDate.setDate(1);
                startDate.setHours(0,0,0,0);
            }

            return Object.entries(postsData).filter(([id, post]) => {
                const postDate = new Date(id.substring(0, 10) + 'T00:00:00');
                return post.status === 'distribuido' && post.analytics && postDate >= startDate;
            });
        }
        
        function renderFixedHeader() {
            document.getElementById('analytics-profile-pic').src = platformData.profilePic || 'https://placehold.co/80x80/1a202c/718096?text=Perfil';
            document.getElementById('analytics-total-posts').textContent = Object.keys(postsData).length;
            const totalFollowers = MAIN_PLATFORMS.reduce((sum, p) => sum + (platformData[p] || 0), 0);
            document.getElementById('analytics-total-followers').textContent = totalFollowers.toLocaleString('pt-BR');
            document.getElementById('analytics-total-following').textContent = (platformData.totalFollowing || 0).toLocaleString('pt-BR');
            
            const totalMembers = Object.values(platformData.members || {}).reduce((sum, count) => sum + count, 0);
            const totalPaidMembers = platformData.totalPaidMembers || 0;
            const conversionRate = totalFollowers > 0 ? (totalMembers / totalFollowers) * 100 : 0;
            document.getElementById('analytics-total-members').textContent = totalMembers.toLocaleString('pt-BR');
            document.getElementById('analytics-total-paid-members').textContent = totalPaidMembers.toLocaleString('pt-BR');
            document.getElementById('analytics-conversion-rate').textContent = `${conversionRate.toFixed(1)}%`;
        }

        function renderAnalyticsPage(range = 'week') {
            document.querySelectorAll('.analytics-filter-btn').forEach(btn => {
                btn.classList.toggle('filter-btn-active', btn.dataset.range === range);
            });
            
            const filteredPosts = getFilteredPosts(range);

            // Rankings
            const rankedByPerf = [...filteredPosts].sort(([, a], [, b]) => {
                const engB = b.analytics.input1 > 0 ? (b.analytics.input2 / b.analytics.input1) * 100 : 0;
                const engA = a.analytics.input1 > 0 ? (a.analytics.input2 / a.analytics.input1) * 100 : 0;
                return engB - engA;
            }).slice(0, 5);
            
            const rankedByViews = [...filteredPosts].sort(([, a], [, b]) => (b.analytics.input1 || 0) - (a.analytics.input1 || 0)).slice(0, 5);
            
            document.getElementById('ranking-performance').innerHTML = rankedByPerf.length ? rankedByPerf.map(([, p]) => `<div class="flex justify-between items-center text-sm p-2 bg-gray-700/50 rounded-md"><strong class="truncate pr-2">${p.titulo || p.tema}</strong><span class="flex-shrink-0 font-bold text-cyan-400">${(p.analytics.input1 > 0 ? (p.analytics.input2 / p.analytics.input1) * 100 : 0).toFixed(2)}%</span></div>`).join('') : '<p class="text-sm text-gray-500 text-center">Sem dados no período.</p>';
            document.getElementById('ranking-views').innerHTML = rankedByViews.length ? rankedByViews.map(([, p]) => `<div class="flex justify-between items-center text-sm p-2 bg-gray-700/50 rounded-md"><strong class="truncate pr-2">${p.titulo || p.tema}</strong><span class="flex-shrink-0 font-bold text-cyan-400">${(p.analytics.input1 || 0).toLocaleString('pt-BR')}</span></div>`).join('') : '<p class="text-sm text-gray-500 text-center">Sem dados no período.</p>';

            // Charts
            renderPerformanceChart(filteredPosts, range);
            renderEngagementTypeChart(filteredPosts);
        }

        function renderPerformanceChart(posts, range) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            let labels = [];
            let dataByUnit = {};

            if (range === 'day') {
                labels = posts.map(([id, p]) => p.titulo || id.slice(-5));
                dataByUnit = posts.map(([,p]) => p.analytics.input1 > 0 ? (p.analytics.input2 / p.analytics.input1) * 100 : 0);
            } else {
                 const dataByDay = posts.reduce((acc, [id, post]) => {
                    const day = id.substring(0, 10);
                    if (!acc[day]) acc[day] = [];
                    const eng = post.analytics.input1 > 0 ? (post.analytics.input2 / post.analytics.input1) * 100 : 0;
                    acc[day].push(eng);
                    return acc;
                }, {});
                labels = Object.keys(dataByDay).sort();
                dataByUnit = labels.map(day => {
                    const dayEngagements = dataByDay[day];
                    return dayEngagements.reduce((a, b) => a + b, 0) / dayEngagements.length;
                });
            }
            
            if(performanceChartInstance) performanceChartInstance.destroy();
            performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Engajamento Médio', data: dataByUnit, borderColor: 'rgba(34, 211, 238, 1)', backgroundColor: 'rgba(34, 211, 238, 0.2)', fill: true, tension: 0.3 }] },
                options: { scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderEngagementTypeChart(posts) {
             const ctx = document.getElementById('engagement-type-chart').getContext('2d');
             const dataByType = posts.reduce((acc, [, post]) => {
                if (!acc[post.type]) acc[post.type] = [];
                const eng = post.analytics.input1 > 0 ? (post.analytics.input2 / post.analytics.input1) * 100 : 0;
                acc[post.type].push(eng);
                return acc;
             }, {});

             const labels = Object.keys(POST_VISUALS).map(k => POST_VISUALS[k].label);
             const data = Object.keys(POST_VISUALS).map(type => {
                const engagements = dataByType[type] || [];
                return engagements.length > 0 ? engagements.reduce((a, b) => a + b, 0) / engagements.length : 0;
             });
             
             if(engagementTypeChartInstance) engagementTypeChartInstance.destroy();
             engagementTypeChartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels, datasets: [{ label: 'Engajamento Médio por Tipo', data, backgroundColor: 'rgba(34, 211, 238, 0.2)', borderColor: 'rgba(34, 211, 238, 1)', pointBackgroundColor: 'rgba(34, 211, 238, 1)' }] },
                 options: {
                    scales: { r: { beginAtZero: true, angleLines: { color: '#4b5563' }, grid: { color: '#4b5563' }, pointLabels: { color: '#d1d5db', font: { size: 10 } }, ticks: { backdropColor: 'rgba(0,0,0,0)', color: '#9ca3af' } } },
                    plugins: { legend: { display: false } }
                }
             });
        }


        // --- Inicialização e Event Listeners ---
        prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
        nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
        document.getElementById('day-view-back-btn').onclick = showDashboardView;
        document.getElementById('post-view-back-btn').onclick = () => showDayView(currentDayViewDate, activeDayViewPeriod, activeDayViewBlocks);
        document.getElementById('config-period-am').onclick = () => { configSelectedPeriod = 'am'; configSelectedBlocks = []; renderPeriodConfigModalContent(); };
        document.getElementById('config-period-pm').onclick = () => { configSelectedPeriod = 'pm'; configSelectedBlocks = []; renderPeriodConfigModalContent(); };
        document.getElementById('confirm-period-btn').onclick = () => { if (configSelectedBlocks.length > 0) { closeAllModals(); showDayView(currentDayViewDate, configSelectedPeriod, configSelectedBlocks); }};
        document.querySelectorAll('#bottom-nav button').forEach(btn => btn.onclick = () => navigateTo(btn.dataset.view) );
        document.getElementById('open-platform-data-modal-btn').onclick = openPlatformDataModal;
        document.querySelectorAll('.analytics-filter-btn').forEach(btn => btn.onclick = () => renderAnalyticsPage(btn.dataset.range));
        communityToggleBtn.addEventListener('click', toggleCommunityPanel);
        window.addEventListener('resize', updateBodyPadding);
        
        document.getElementById('add-hashtag-btn').addEventListener('click', () => addTag('hashtag'));
        document.getElementById('add-link-btn').addEventListener('click', () => addTag('link'));
        document.getElementById('new-hashtag-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTag('hashtag'); } });
        document.getElementById('new-link-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTag('link'); } });
        document.getElementById('copy-post-content-btn').addEventListener('click', () => {
            const content = document.getElementById('platform-post-content-body').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copy-post-content-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copiado!';
                btn.classList.add('bg-green-500');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-500');
                }, 2000);
            });
        });

        function renderPeriodConfigModalContent() {
            const periodAmBtn = document.getElementById('config-period-am'); const periodPmBtn = document.getElementById('config-period-pm');
            const blocksContainer = document.getElementById('config-time-blocks'); const confirmBtn = document.getElementById('confirm-period-btn');
            periodAmBtn.classList.toggle('period-btn-active', configSelectedPeriod === 'am'); periodPmBtn.classList.toggle('period-btn-active', configSelectedPeriod === 'pm');
            const blocks = { am: ["00:00 - 03:59", "04:00 - 07:59", "08:00 - 11:59"], pm: ["12:00 - 15:59", "16:00 - 19:59", "20:00 - 23:59"] };
            blocksContainer.innerHTML = '';
            blocks[configSelectedPeriod].forEach((blockText, index) => {
                const blockBtn = document.createElement('button'); blockBtn.textContent = blockText;
                blockBtn.className = 'px-3 py-2 text-sm font-medium rounded-md transition-colors';
                if(configSelectedBlocks.includes(index)) { blockBtn.classList.add('period-btn-active'); } 
                else { blockBtn.classList.add('border', 'border-gray-600', 'hover:bg-gray-700'); }
                blockBtn.onclick = () => {
                    const selectedIndex = configSelectedBlocks.indexOf(index);
                    if (selectedIndex > -1) { configSelectedBlocks.splice(selectedIndex, 1); } 
                    else { if (configSelectedBlocks.length < 3) { configSelectedBlocks.push(index); } }
                    renderPeriodConfigModalContent();
                };
                blocksContainer.appendChild(blockBtn);
            });
            if (configSelectedBlocks.length > 0) { confirmBtn.disabled = false; confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed'); } 
            else { confirmBtn.disabled = true; confirmBtn.classList.add('opacity-50', 'cursor-not-allowed'); }
        }

        window.onclick = function(event) { if (event.target.classList.contains('modal-backdrop')) { closeAllModals(); } }

        // Renderização inicial
        renderFixedHeader();
        navigateTo('dashboard-view');
        renderCalendar();
        applyCommunityPanelState();
        updateBodyPadding();
    </script>
</body>
</html>

